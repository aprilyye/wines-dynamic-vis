<html>

<head>
	<script src="https://d3js.org/d3.v5.min.js"></script>
	<script src="https://d3js.org/topojson.v2.min.js"></script>
	<style>
		body {
			color: #fcf9f9;
			background-color: #22252d;
			font-family: "Arial";
		}

		h1 {
			text-align: center;
			margin-top: 40px;
		}

		#p1 {
			text-align: center;
			font-size: 35px;
		}

		#psub {
			text-align: center;
			font-size: 25px;
		}

		#g2 {
			margin-top: 50px;
			margin-left: 30px;
			text-align: left;
			float: left;
			/* position: relative; */
		}

		#btn {
			display: inline-block;
			margin-top: 50px;
			float: right;
			text-align: left;
			width: 50%
		}

		.button {
			background-color: #f4f4f4;
			margin: 5px;
			border: none;
			text-align: center;
			display: table-cell;
			font-size: 12px;
			font-family: "Arial";
			padding: 10px 5px;
			border-radius: 8px;
			width: 22%;
		}

		.button:hover {
			background-color: #e25bf7;
			color: white;
		}

		.button:focus {
			background-color: #e25bf7;
			color: white;
		}

		.gridlines line {
			stroke: #bbb;
		}

		.gridlines .domain {
			stroke: none;
		}
	</style>
</head>

<body>
	<h1>Wine Reviews Trends </h1>
	<p id="p0">Graph 1 <br />
		<svg id=g1 height="900" width="1000" style="border:3px solid black"></svg>
		<script>
			let svg = d3.select("svg#g1");

			let grapes = [];
			let topGrapes = [];
			let regions = [];
			let topProvinces = [];
			let provinces = [];
			let colors = ["#ECDB54", "#E94B3C", "#6F9FD8", "#944743", "#DBB1CD", "#EC9787", "#00A591", "#6B5B95", "#BC70A4", "#BFD641"];

			//let counts = [];
			d3.csv("./winemag-data-130k-v2.csv").then(function (data) {

				data = data.filter(d => d['region_1'] != '' && d['price'] != '');
				//console.log(data);
				data.forEach((d, i) => {
					// if(!grapes.includes(d['variety'])) {
					// 	grapes.push(d['variety']);
					// 	regions.push(d['region_1']);
					// }
					if (d['points'] == '100') {
						topGrapes.push(d['variety']);
						topProvinces.push([d['province']]);
					}
				});
				//console.log(topRegions);

				let counts = new Array(topGrapes.length);
				counts.fill(1);
				//console.log(counts);
				data.forEach((d, i) => {
					if (topGrapes.includes(d['variety'])) {
						counts[topGrapes.indexOf(d['variety'])] += 1;
						if (!(topProvinces[topGrapes.indexOf(d['variety'])]).includes(d['province'])) {
							topProvinces[topGrapes.indexOf(d['variety'])].push(d['province']);
							if (!provinces.includes(d['province'])) {
								provinces.push(d['province']);
							}
						}

					}
				});

				// APRIL GRAPE COUNTING FOR SCATTERPLOT
				let grapesCount = [];
				// increment count of grapes accordingly
				data.forEach((d, i) => {
					if (grapesCount.findIndex(p => p.grape === d['variety']) == -1) {
						grapesCount.push({
							"grape": d['variety'],
							"count": 1
						})
					} else {
						var curGrape = grapesCount.find(p => p.grape === d['variety']);
						curGrape.count++;
					}
				});

				grapesCount.sort(function (a, b) { return b.count - a.count });
				// take only top 50
				let top50grapeNested = grapesCount.slice(0, 10);
				let top50grapes = [];
				top50grapeNested.forEach(d => {
					top50grapes.push(d.grape);
				});
				top50grapes.sort(); // sort alphabetical

				//console.log("grapes count =", grapesCount);
				//console.log("top 50 grapes =", top50grapes);

				// let uniqueGrapes = [...new Set(topGrapes)].sort();
				// uniqueGrapes.splice(7,1); // this grape has count = 0 when displaying in scatter

				// END OF APRIL GRAPE COUNTING

				topGrapes.splice(7, 1);
				topProvinces.splice(7, 1);
				topGrapes.splice(8, 1);
				topProvinces.splice(8, 1);


				// console.log("grapes: ");
				// console.log(topGrapes);
				// console.log("top provinces: ");
				// console.log(topProvinces);
				// console.log("provinces: ");
				// console.log(provinces);
				// console.log("counts: ");
				// console.log(counts);

				// svg.append("circle")
				// .attr("cx", 400)
				// .attr("cy", 350)
				// .attr("r", 300)
				// .attr("stroke", "black")
				// .attr("stroke-width", 2)
				// .attr("fill", "none")

				let rotation;

				//PROVINCES ON THE LEFT
				for (var i = 0; i < provinces.length; i++) {
					rotation = 3 * i;
					rotation += 90;
					labelRot = 3 * i;
					labelRot -= 90;
					let provinceCircles = svg.append('circle')
						.attr('r', 4)
						.attr('cx', 450)
						.attr('cy', 350)
						.attr('id', provinces[i].split(" ")[0]) // CHECK THIS??
						.attr('fill', 'white')
						.attr('transform', function (d) {
							return 'translate(270, 100) rotate(' + rotation + ',' + 160 + ',' + 300 + ')';
						});

					var provinceLabels = svg.append('text')
						.attr('x', 200)
						.attr('y', 150)
						.attr('font-size', 12)
						.attr('fill', 'white')
						.attr('text-anchor', 'end')
						.attr('transform', function (d) {
							return 'translate(-80, 200) rotate(' + labelRot + ',' + 510 + ',' + 200 + ')';
						})
						.text(provinces[i]);

				}

				//GRAPES ON THE RIGHT
				let x = 0
				let arcGenerator = d3.arc()
				for (var i = Math.PI / 5; i <= 4 * Math.PI / 5; i += Math.PI / 15) {
					let pathData = arcGenerator({
						startAngle: i,
						endAngle: i + Math.PI / 20,
						innerRadius: 280,
						outerRadius: 300
					});
					svg.append("path")
						.attr('d', pathData)
						.attr('id', "arc" + x)
						//.attr('id', topGrapes[i].split(" ")[0]) // CHECK THIS??
						//.attr('fill-opacity', new_opac)
						.attr('fill', colors[x])
						.attr('stroke', colors[x])
						.attr('stroke-width', 3)
						.attr('transform', 'translate(450, 400)')
						.on("mouseover", function () {
							d3.select(this)
								.transition().duration(400)
								.attr('stroke-width', 20)

							//console.log(this.id);

							topProvinces.forEach((d, i) => {
								if (i < 10) {
									//console.log(i);
									d.forEach((d2, i2) => {
										if (d2.split(" ")[0] != "Champagne" && i != this.id.replace("arc", "")) {
											d3.select("#grape" + i + "province" + i2).remove()
										}

									})
								}
							});
						})
						.on("mouseout", function () {
							d3.select(this)
								.transition().duration(400)
								.attr('stroke-width', 3)

							//console.log(this.id);

							topProvinces.forEach((d, i) => {
								if (i < 10) {
									//console.log(i);
									d.forEach((d2, i2) => {
										if (d2.split(" ")[0] != "Champagne" && i != this.id.replace("arc", "")) {
											let cirCoordinates = d3.select("#" + d2.split(" ")[0]).node().getBoundingClientRect();
											let arcCoordinates = d3.select("#arc" + i).node().getBoundingClientRect();
											//console.log(d2.split(" ")[0]);
											//console.log(cirCoordinates);
											svg.append("line")
												.attr("id", "grape" + i + "province" + i2)
												.attr("x1", cirCoordinates.left + cirCoordinates.width / 2)
												.attr("y1", cirCoordinates.bottom - cirCoordinates.height / 2 + window.scrollY)
												.attr("x2", arcCoordinates.left + arcCoordinates.width / 2)
												.attr("y2", arcCoordinates.bottom - arcCoordinates.height / 2 + window.scrollY)
												.attr("transform", "translate(-10, -120)")
												.attr("stroke", colors[i])
												.attr("stroke-width", 1);

										}

									})
								}
							});
						})

					x++;
				}
				for (var i = 0; i < 10; i++) {
					rotation = i * 10;
					rotation += -40;
					var grapeLabels = svg.append("text")
						.attr("x", 500)
						.attr("y", 220)
						.text(topGrapes[i])
						.attr("text-anchor", "start")
						.attr("fill", "white")
						.attr("font-size", "12px")
						.attr("transform", function (d) {
							return "translate(260, 175) rotate(" + rotation + "," + 130 + "," + 215 + ")";
						})
				}
				//let test = d3.select("#Connecticut").node().getBoundingClientRect();
				//let test = d3.select("arc4").node().getBoundingClientRect();
				// svg.append("rect")
				// 	.attr("x", test.x)
				// 	.attr("y", test.y)
				// 	.attr("width", test.width)
				// 	.attr("height", test.height)
				// 	.attr("stroke", "red")
				// 	.attr("stroke-width", 1);

				//console.log(test);
				//console.log(test.node().getBoundingClientRect());
				// LINES
				topProvinces.forEach((d, i) => {
					if (i < 10) {
						// console.log(i);
						d.forEach((d2, i2) => {
							if (d2.split(" ")[0] != "Champagne") {
								let cirCoordinates = d3.select("#" + d2.split(" ")[0]).node().getBoundingClientRect();
								let arcCoordinates = d3.select("#arc" + i).node().getBoundingClientRect();
								//console.log(d2.split(" ")[0]);
								//console.log(cirCoordinates);
								svg.append("line")
									.attr("id", "grape" + i + "province" + i2)
									.attr("x1", cirCoordinates.left + cirCoordinates.width / 2)
									.attr("y1", cirCoordinates.bottom - cirCoordinates.height / 2 + window.scrollY)
									.attr("x2", arcCoordinates.left + arcCoordinates.width / 2)
									.attr("y2", arcCoordinates.bottom - arcCoordinates.height / 2 + window.scrollY)
									.attr("transform", "translate(-10, -120)")
									.attr("stroke", colors[i])
									.attr("stroke-width", 1);

							}

						})
					}
				});

				// APRIL'S PART
				let svg2 = d3.select("#g2");

				// make margins for graph
				let width = svg2.attr("width");
				let height = svg2.attr("height");
				let margin = { top: 10, right: 20, bottom: 60, left: 80 };
				let graphWidth = width - margin.left - margin.right;
				let graphHeight = height - margin.top - margin.bottom;

				// x axis
				let maxPoint = d3.max(data, d => parseInt(d['points'], 10));
				let minPoint = d3.min(data, d => parseInt(d['points'], 10));
				// console.log("max points =", minPoint, maxPoint);

				var pointScale = d3.scaleLinear()
					.domain([minPoint, maxPoint])
					.range([0, graphWidth]);

				// y axis
				let maxPrice = d3.max(data, d => parseFloat(d['price']));
				let minPrice = d3.min(data, d => parseFloat(d['price']));
				// console.log("max price =", minPrice, maxPrice);

				var priceScale = d3.scaleLog()
					.domain([minPrice + 1, maxPrice + 1])
					.range([graphHeight, 0]);

				var leftAxis = d3.axisLeft(priceScale).tickFormat(d3.format("$.01s"));
				let yAxisLayer = svg2.append("g")
					.attr("class", "y axis")
					.attr("transform", "translate(" + (margin.left - 10) + "," + margin.top + ")")
					.call(leftAxis);

				var bottomAxis = d3.axisBottom(pointScale);
				let xAxisLayer = svg2.append("g")
					.attr("class", "x axis")
					.attr("transform", "translate(" + margin.left + "," + (margin.top +
						graphHeight + 10) + ")")
					.call(bottomAxis);

				let leftGridlines = d3.axisLeft(priceScale)
					.tickSize(-graphWidth - 10).tickFormat("");

				let yGridlineLayer = svg2.append("g").attr("class", "y gridlines")
					.attr("transform", "translate(" + (margin.left - 10) + "," + margin.top + ")")
					.call(leftGridlines);

				let bottomGridlines = d3.axisBottom(pointScale)
					.tickSize(-graphHeight - 10).tickFormat("");

				let xGridlineLayer = svg2.append("g").attr("class", "x gridlines")
					.attr("transform", "translate(" + (margin.left) + "," + (margin.top + graphHeight + 10) + ")")
					.call(bottomGridlines);

				let top20prov = [];
				let provCount = [];
				provinces.forEach((d, i) => {
					provCount.push({
						"province": provinces[i],
						"count": 0
					});
				});

				// increment count of provinces accordingly
				data.forEach((d, i) => {
					if (provinces.includes(d['province'])) {
						var curProv = provCount.find(p => p.province === d['province']);
						curProv.count++;
					}
				});

				// sort provCount by count of provinces in desc order
				provCount.sort(function (a, b) { return b.count - a.count });
				// take only top 20
				top20prov = provCount.slice(0, 20);

				var filteredData = data.filter(d =>
					d['taster_twitter_handle'] != "" &&
					d['taster_name'] != ""
				);

				let scatterWrapper = svg2.append("g");
				let scatter = scatterWrapper.append("g")
					.attr("transform", "translate(" + (margin.left) + "," + (margin.top) + ")");

				function scatterCircles(grape) {
					var grapeCount = 0;
					var tooltip = d3.select("body").append("div")
						.attr("class", "tooltip")
						.style("opacity", 0);

					filteredData.forEach((d, i) => {
						if (top50grapes.includes(d['variety']) &&
							top20prov.findIndex(p => p.province == d['province']) != -1) {
							if (grape == "" || d['variety'] == grape) {
								grapeCount++;
								scatter.append("circle")
									.attr("r", 7)
									.attr("cx", pointScale(d['points']))
									.attr("cy", priceScale(d['price']))
									.style("fill", "#e25bf7")
									.style("opacity", 0.5)
									.on("mouseover", function () {
										d3.select(this)
											.attr("r", 14)
											.style("fill", "#fceafc")
											.style("opacity", .8);

										var gInfo = scatter.append("g")
											.attr("class", "someClass");

										gInfo.append("rect")
											.attr("id", "r" + d.x + "-" + d.y + "-" + i)
											.attr("x", pointScale(d['points']) + 20)
											.attr("y", priceScale(d['price']) - 20)
											.attr("rx", 6)
											.attr("ry", 6)
											.attr("width", 250)
											.attr("height", 140)
											.attr("fill", "#fceafc")
											.style("opacity", 0.7)

										gInfo.append("text")
											.attr("id", "t" + d.x + "-" + d.y + "-" + i)
											.attr("dx", pointScale(d['points']) + 30)
											.attr("dy", priceScale(d['price']) + 5)
											.attr("font-size", "16px")
											.attr("font-weight", "bold")
											.style("fill", "black")
											.text("review by: " + d['taster_name']);

										gInfo.append("text")
											.attr("id", "t" + d.x + "-" + d.y + "-" + i)
											.attr("dx", pointScale(d['points']) + 30)
											.attr("dy", priceScale(d['price']) + 25)
											.attr("font-size", "14px")
											// .attr("font-weight", "bold")
											.style("fill", "black")
											.text("rating: " + d['points']);

										gInfo.append("text")
											.attr("id", "t" + d.x + "-" + d.y + "-" + i)
											.attr("dx", pointScale(d['points']) + 30)
											.attr("dy", priceScale(d['price']) + 45)
											.attr("font-size", "14px")
											// .attr("font-weight", "bold")
											.style("fill", "black")
											.text("price: $" + parseFloat(d['price']).toFixed(2));

										gInfo.append("text")
											.attr("id", "t" + d.x + "-" + d.y + "-" + i)
											.attr("dx", pointScale(d['points']) + 30)
											.attr("dy", priceScale(d['price']) + 65)
											.attr("font-size", "14px")
											// .attr("font-weight", "bold")
											.style("fill", "black")
											.text("variety: " + d['variety']);

										gInfo.append("text")
											.attr("id", "t" + d.x + "-" + d.y + "-" + i)
											.attr("dx", pointScale(d['points']) + 30)
											.attr("dy", priceScale(d['price']) + 85)
											.attr("font-size", "14px")
											// .attr("font-weight", "bold")
											.style("fill", "black")
											.text("province: " + d['province']);

										gInfo.append("text")
											.attr("id", "t" + d.x + "-" + d.y + "-" + i)
											.attr("dx", pointScale(d['points']) + 30)
											.attr("dy", priceScale(d['price']) + 105)
											.attr("font-size", "14px")
											// .attr("font-weight", "bold")
											.style("fill", "black")
											.text("region: " + d['region_1']);

									})
									.on("mouseout", function () {
										d3.select(this)
											.attr("r", 7)
											.style("fill", "#e25bf7")
											.style("opacity", .7);
										d3.selectAll("#t" + d.x + "-" + d.y + "-" + i).remove();
										d3.select("#r" + d.x + "-" + d.y + "-" + i).remove();

									});
							}
						}
					});

					// console.log("count =", grapeCount);
				}

				scatterCircles("");

				svg2.append("text")
					.attr("text-anchor", "middle")
					.attr("x", width / 2)
					.attr("y", height - 5)
					.attr("fill", "white")
					.attr("font-size", "16px")
					.text("wine rating")

				svg2.append("text")
					.attr("text-anchor", "middle")
					.attr("x", -height / 2)
					.attr("y", 20)
					.attr("fill", "white")
					.attr("transform", "rotate(-90)")
					.attr("font-size", "16px")
					.text("wine price")

				// make buttons to filter scatterplot
				d3.select("div#btn").selectAll("input")
					.data(top50grapes)
					.enter()
					.append("input")
					.attr("type", "button")
					.attr("class", "button")
					.attr("value", d => d)
					.on("click", function (d) {
						svg2.selectAll("circle").remove();
						scatterCircles(d);
					});

			});

		</script>
	</p>
	<p id="p1">Is there a correlation between a wine's price and its rating? <br />
		<p id="psub"> Hover over a wine data point to learn more about it <br />
			<svg id=g2 height="600" width="700"></svg>
		</p>
		<div id=btn>
		</div>
	</p>

	<p>
	</p>

</body>

</html>
